# Agent 指示仕様 — Google カレンダー統合 via MCP（削除機能なし版）

## 🎯 プロジェクト目的（High-Level Goal）

AI エージェント（MCP クライアント）が、ユーザーの Google カレンダーを MCP 経由で安全に参照・追加・更新できるようにする。
ただし「予定の削除」は禁止／省略。誤削除リスクを避ける仕様とする。

## 🔗 参考リポジトリ / 仕様リンク

- MCP 公式 ： https://modelcontextprotocol.io/docs/develop/build-server
- MCP Rust SDK
  https://github.com/modelcontextprotocol/rust-sdk
- Google Calendarの既存で存在するMCP
  https://github.com/nspady/google-calendar-mcp

これらを Agent 実装時の “参照すべき資料” として明示する。

## 📋 要件仕様

### 機能要件

1. **認証／認可フロー統合**
   - MCP 認可仕様（OAuth 2.1, PKCE, メタデータ公開, 動的クライアント登録）と Google OAuth を連携。
   - ユーザー同意画面 → 認可コード取得 → トークン交換 → トークン安全保存 を自動化。
   - 認可誘導経路とコールバック経路のハンドラを持つ。

2. **トークン管理**
   - アクセストークンとリフレッシュトークンを安全に保存（暗号化、アクセス制御）。
   - 有効期限切れ時の自動リフレッシュ処理。
   - トークン失効、ユーザー取消、更新失敗時の例外処理とフォールバックロジック。

3. **カレンダー操作：参照および更新（削除なし）**
   - **予定一覧取得**（クエリ条件、時間範囲、ページネーション対応）
     - `events.list` エンドポイント使用
   - **予定取得（個別イベント取得）**
   - **予定作成**（タイトル、開始時刻／終了時刻、説明、場所、参加者、リマインダー等）
   - **予定更新**（PATCH / PUT による編集可能項目の修正）
   - **削除操作は提供しない**（UI／API レベルで禁止）
   - エラー復帰ロジック、レートリミット対応、バックオフ戦略実装

4. **MCP ツール定義 & ラッパー設計**
   - `Tool Definition` の仕様に沿って、以下を設計：
     - 入力パラメータと返却型
     - 使用可能な操作（list, get, create, update）
   - クライアント要求を受け、Google API 呼び出しを行いレスポンスを MCP 規格形式に整形して返す。
   - 権限制約（どのクライアント／ユーザーがどの操作を許可されているか）をチェック。
   - Remote MCP (SSE) エンドポイント (`/mcp/sse`, `/mcp/message`) を公開し、MCP クライアントが直接接続できるようにする。

5. **認可誘導レスポンス処理**
   - MCP クライアントから認可されていない状態でアクセスされた場合、適切な 401 Unauthorized / 認可 URL を返すレスポンス。
   - 認可後のコールバック処理で、認可済トークンを確定させ、状態を MCP サーバー側で保持。

6. **構成管理・運用対応**
   - Google OAuth クライアント ID / シークレット、リダイレクト URI を構成可能とする（環境変数 or 設定ファイル）。
   - ロギング、監査ログ、エラー通知機構。
   - TLS／HTTPS 対応強制化。
   - Rust nightly toolchain の利用前提（rmcp crate が edition 2024 を要求するため）。

### 非機能要件

- セキュリティ最優先：トークン漏洩防止、最小権限原則、入力検証
- 拡張性確保：将来 Gmail や Drive 等の他 API を同様に統合できるアーキテクチャ
- モジュール性：OAuth モジュール、Google API モジュール、MCP インターフェースモジュールを分割
- テスト容易性：単体テスト・統合テストを設計可能な構成
- 可観測性：ログ、メトリクス、エラー追跡

## 🏗 ファイル構成案（Rust実装向け）

```

agent.md
/src
/oauth             ← MCP＋Google OAuth 統合モジュール
/google_calendar   ← Google Calendar API 呼び出しラッパー（list, get, create, update）
/mcp               ← MCP ツールインターフェース実装モジュール
/handlers          ← 認可誘導／コールバック／中継処理
/tests
/unit
/integration
/config
config.toml │ .env      ← Google OAuth クライアント情報、リダイレクト URI 等
/docs
design.md
api_reference.md
usage_guide.md

```

## 🧠 実装フェーズ指示（Agent に対して）

1. **調査および設計**
   - MCP OAuth 認可仕様 (Authorization 2025-03-26) を読む。
   - Google OAuth / Google Calendar API ドキュメントを参照。
   - リンク済 GitHub リポジトリを参照し、Rust SDK 実装例を探して共有。
   - アーキテクチャ図とモジュール構成図を作成。
   - 各モジュールの API シグネチャ（関数名、引数、戻り値）を定義。
   - エラーシナリオ、リトライ戦略、権限チェックルールを設計。

2. **モジュール単位の実装**
   - OAuth 統合モジュール（PKCE、認可 URL 生成、コールバック処理、トークン交換、保存、リフレッシュ）
   - Google Calendar API モジュール（list, get, create, update 呼び出し及びレスポンス整形）
   - MCP インターフェースモジュール（クライアント要求を翻訳し、MCP 規格レスポンスを生成）
   - 認可誘導／中継ハンドラモジュール

3. **統合と End-to-End テスト**
   - 認可誘導 → 認可 → コールバック → カレンダー操作（取得／作成／更新）までの流れを統合
   - 異常系テスト（無効トークン、認可取り消し、トークン更新失敗、API レート制限）
   - ログ・監査出力確認

4. **レビュー・セキュリティチェック**
   - トークン管理設計、安全性、過剰権限の抑制
   - 入力検証・パラメータバリデーション
   - ログに機微情報を出さないように
   - 拡張性・他 API 追加対応性の確認

5. **最終確認およびドキュメント整備**
   - 要件チェックリストとの突合
   - ドキュメント（設計、API 仕様、利用ガイド）整備
   - コード整形、リント、テスト通過確認

## ✅ 要件チェックリスト（Agent が最後に確認すべきこと）

- [ ] 認証／認可フローが MCP 規格と整合しているか
- [ ] Google OAuth → トークン取得・保存・更新が正しく動くか
- [ ] 予定取得・作成・更新操作が MCP ツールとして動くか
- [ ] 削除操作が一切存在しない仕様か
- [ ] エラーケース対応（期限切れ、無効、取り消し）を網羅しているか
- [ ] セキュリティ観点（トークン管理、入力検証、ログ等）問題なしか
- [ ] 拡張性確保（将来他 API を追加できる構成）か
- [ ] 参照すべき GitHub／ドキュメントリンクが明記されているか

```

この仕様を agent.md として使えば、Cursor や Claude Code は「参照すべきリンクも見ながら設計 → 実装 →統合 →テスト →最終仕様の確認」まで順にやってくれるはず。
気になる点あれば変える。
